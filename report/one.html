<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>INSPINIA | c3.js</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- c3 Charts -->
    <link href="css/plugins/c3/c3.min.css" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">


</head>

<body>
    <div id="wrapper">

        <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
        </div>
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-10">
                <h2>报表</h2>
                <ol class="breadcrumb">
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a>Graphs</a>
                    </li>
                    <li class="active">
                        <strong>Reports</strong>
                    </li>
                </ol>
            </div>
            <div class="col-lg-2">

            </div>
        </div>
        <div class="wrapper wrapper-content animated fadeInRight">
		<div class="row">
			<div class="col-lg-12">
			<textarea id="input" style="width: 70%;height: 200px;" ></textarea>
			<br/>
			<input type="button" id="clickMe" class="btn btn-primary" style="margin-buttom: 20px;" value="计算" />
			</div>
		<div>
			<div id="target"></div>
        </div>
        <div class="footer">
            <div class="pull-right">
                10GB of <strong>250GB</strong> Free.
            </div>
            <div>
                <strong>Copyright</strong> Example Company &copy; 2014-2015
            </div>
        </div>

        </div>
        </div>



    <!-- Mainly scripts -->
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- d3 and c3 charts -->
    <script src="js/plugins/d3/d3.min.js"></script>
    <script src="js/plugins/c3/c3.min.js"></script>

    <script>
    	
		$("#clickMe").click(function(){
			var data = {};
			var targetPage = $("#target");
			targetPage.html("");
			
			var tableData = $("#input").val().split("\n");
			for(var ids in tableData){
				var text = tableData[ids];
				var first = true;
				if(text != ""){
					var colArray = text.split("	");
					var 月份 = ""+colArray[0];
					
					if(first){
						first = false;
						alert(月份);
						if(月份 == "月份"){
								continue;
						}
					}

					var 社区 = colArray[1];
					var 乐购 = colArray[2];
					var 旅游 = colArray[3];
					var 洗衣 = colArray[4];
					var 保洁 = colArray[5];	

					if(!(社区 == null || 社区 == "" || 社区 === undefined)){
						var det = data[社区];
						if(det == null || det == "" || det === undefined){
						  det = {};
						  data[社区] = det;
						}
						var monthData = det[月份];
						if(monthData == null || monthData == "" || monthData === undefined){
							monthData = {};
							det[月份] = monthData;
						}
						monthData["乐购"] = 乐购;
						monthData["旅游"] = 旅游;
						monthData["洗衣"] = 洗衣;
						monthData["保洁"] = 保洁;
					}
				}
			}
			//alert(data);
			//console.log(data);
				
			doFunction(data, targetPage);

		});

	function doFunction(data, targetPage){
		
		var monthCategories = [];
		for(var t in data){
			for(var m in data[t]){
				var mName = m+"月";
				var exists = false;
				for(var idx = 0; idx < monthCategories.length; idx ++){
					if(monthCategories[idx] == mName){
					 exists = true;
					}
				}
				if(!exists){
				  monthCategories.push(mName);
				}
			}
		}

		var i = 0;
		for(var 社区名 in data){
			var id = "XXX" + i++;
			var htmlData = template.replace("{{title}}", 社区名).replace("{{id}}", id);
			targetPage.append(htmlData);

			var targetData = data[社区名];
			var columns = [];

			var newCategories = [];
			
			var lgDataLast = 0;
			var lyDataLast = 0;
			var xyDataLast = 0;
			var bjDataLast = 0;
			var firstMonth = true;
			for(var j = 1; j <= monthCategories.length; j++){
				var eachMonthData = targetData[j+""];
				var lgData = 0;
				var lyData = 0;
				var xyData = 0;
				var bjData = 0;
				if(!(eachMonthData == null || eachMonthData == undefined || eachMonthData == "")){
					lgData = eachMonthData["乐购"];
					lyData = eachMonthData["旅游"];
					xyData = eachMonthData["洗衣"];
					bjData = eachMonthData["保洁"];
				}
				
				var cate = monthCategories[j-1];
				newCategories[j-1] = cate;
				if(firstMonth || lgDataLast == 0){
					firstMonth = false;
					newCategories[j-1] += "(+0.0%)";
				}else{
					var pers = ((lgData - lgDataLast)/lgDataLast * 100);
					newCategories[j-1] += "("+ (pers >= 0?"+":"") + pers.toFixed(2) + "%"+")";
				}

			  lgDataLast = lgData;
			  lyDataLast = lyData;
			  xyDataLast = xyData;
			  bjDataLast = bjData;

				var 乐购 = columns[0];
				if(乐购 == null || 乐购 == undefined){
				  乐购 = ["乐购", ];
				  columns[0] = 乐购;
				}
				乐购.push(lgData);
				
				var 旅游 = columns[1];
				if(旅游 == null || 旅游 == undefined){
				  旅游 = ["旅游", ];
				  columns[1] = 旅游;
				}
				旅游.push(lyData);
								
				var 洗衣 = columns[2];
				if(洗衣 == null || 洗衣 == undefined){
				  洗衣 = ["洗衣", ];
				  columns[2] = 洗衣;
				}
				洗衣.push(xyData);
								
				var 保洁 = columns[3];
				if(保洁 == null || 保洁 == undefined){
				  保洁 = ["保洁", ];
				  columns[3] = 保洁;
				}
				保洁.push(bjData);
			}

      c3.generate({
        bindto: '#'+id,
        data:{
            columns: columns,
            colors:{
                乐购: 'red',
                旅游: 'blue',
								洗衣: 'orange',
								保洁: 'black'
					  }
				},
				axis: {
					x: {
						type: 'category',
						categories: newCategories
					}
				}
      });
		}
	}

var template = " \
<div class=\"row\"> \
<div class=\"col-lg-6\"> \
    <div class=\"ibox float-e-margins\"> \
        <div class=\"ibox-title\"> \
            <h5>{{title}}</h5> \
        </div> \
        <div class=\"ibox-content\"> \
            <div> \
                <div id=\"{{id}}\"></div> \
            </div> \
        </div> \
    </div> \
</div> \
</div> \
";
	
	
    </script>

</body>

</html>
